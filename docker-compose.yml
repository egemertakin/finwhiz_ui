services:
  llm:
    build:
      context: ./src/llm
      dockerfile: Dockerfile
    image: finwhiz_llm
    container_name: finwhiz_llm
    ports:
      - "8001:8001"
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
      - GOOGLE_APPLICATION_CREDENTIALS=${BUCKET_CREDENTIALS}
      - VERTEXAI_CREDENTIALS=${VERTEXAI_CREDENTIALS}
    # depends_on:
    #   - postgres
    volumes:
      - .:/app
      - ./secrets/service-account-key.json:/app/secrets/service-account-key.json:ro
      - ./secrets/vertexai-service-account.json:/app/secrets/vertexai-service-account.json:ro
    restart: unless-stopped
    networks:
      - finwhiz_network

    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8001/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 12
      start_period: 30s
  agent:
    build:
      context: ./src/agentic_user_data_processing
      dockerfile: Dockerfile
      
    image: finwhiz_agent
    container_name: finwhiz_agent
    volumes:
      - .:/app
      - ./secrets/service-account-key.json:/app/secrets/service-account-key.json:ro
    ports:
      - "8010:8010"
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app:/app/src
      - DATABASE_URL=${DATABASE_URL}
      - USER_UPLOAD_BUCKET=${USER_UPLOAD_BUCKET}
      - GOOGLE_APPLICATION_CREDENTIALS=${BUCKET_CREDENTIALS}
      - DB_USER=${DB_USER}
      - DB_PASS=${DB_PASS}
      - DB_NAME=${DB_NAME}
      - DB_HOST=${DB_HOST}
    depends_on:
      llm:
        condition: service_healthy
      # postgres:
      #   condition: service_started
    restart: unless-stopped
    networks:
      - finwhiz_network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8010/health"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s
  query_client:
    build:
      context: ./src/query_client
      dockerfile: Dockerfile
    image: finwhiz_query
    container_name: finwhiz_query
    depends_on:
      llm:
        condition: service_healthy
      agent:
        condition: service_healthy
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
      - LLM_URL=http://llm:8001
      - AGENT_URL=http://agent:8010
    command: /bin/bash -c "sleep 8 && source /home/app/.venv/bin/activate && python src/query_client/interactive_query.py"
    volumes:
      - .:/app
    stdin_open: true
    tty: true
    networks:
      - finwhiz_network
    restart: on-failure

  cloudsql-proxy:
    image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.11.3
    command:
      - "--address=0.0.0.0"
      - "--port=5432"
      - "finwhiz-ac215:us-central1:finwhiz-cloud-sql"
    environment:
      - GOOGLE_APPLICATION_CREDENTIALS=/app/secrets/proxy-key.json
    volumes:
      - ./secrets/proxy-key.json:/app/secrets/proxy-key.json:ro
      - ./secrets/sql_password.txt:/app/secrets/sql_password.txt:ro
    networks: 
      - finwhiz_network
    restart: unless-stopped
  # postgres:
  #   image: postgres:16
  #   container_name: finwhiz_postgres
  #   environment:
  #     POSTGRES_USER: finwhiz
  #     POSTGRES_PASSWORD: finwhiz
  #     POSTGRES_DB: finwhiz
  #   ports:
  #     - "5432:5432"
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   networks:
  #     - finwhiz_network
  #   restart: unless-stopped

networks:
  finwhiz_network:
    driver: bridge